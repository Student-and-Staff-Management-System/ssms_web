<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Bio-Data Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    {% load static %}
    <!-- This should link to your main.css file if you are using a base template -->
    <!-- <link rel="stylesheet" href="{% static 'css/main.css' %}"> -->
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #5a7d7c;
            --accent-color-hover: #4a6b69;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-header h1 {
            font-size: 2.5em;
            margin: 0;
        }

        .form-header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .accordion-item {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .accordion-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-header h2 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 20px;
        }

        .accordion-item.active .accordion-content {
            padding: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            background-color: #fff;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-group {
            flex-direction: row;
            align-items: center;
            gap: 20px;
            padding: 10px 0;
        }

        .radio-group>label {
            margin-bottom: 0;
        }

        .radio-group>div {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .radio-group>div>label {
            font-weight: 400;
            color: var(--text-primary);
        }

        .conditional-section {
            display: none;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .submit-btn {
            background-color: var(--accent-color);
            color: #ffffff;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background-color: var(--accent-color-hover);
        }

        h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 10px;
            color: var(--accent-color);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form-header">
            <img src="{% static 'imgs/aublack.png' %}" alt="University Logo" width="150" height="auto" />
            <h1>Student Registration</h1>
            <p>Department of Information Technology</p>
        </div>

        <form id="registration-form" method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Student & Login Details</h2>
                </div>
                <div class="accordion-content">
                    <div class="form-grid">
                        <div class="input-group"><label for="student_name">Name</label><input type="text"
                                id="student_name" name="student_name" required></div>
                        <div class="input-group"><label for="roll_number">Roll Number</label><input type="text"
                                id="roll_number" name="roll_number" required></div>
                        <div class="input-group"><label for="register_number">Register Number</label><input type="text"
                                id="register_number" name="register_number"></div>
                        <div class="input-group"><label for="student_email">Email</label><input type="email"
                                id="student_email" name="student_email" required></div>
                        <div class="input-group"><label for="password">Password</label><input type="password"
                                id="password" name="password" required></div>
                        <div class="input-group"><label for="confirm-password">Confirm Password</label><input
                                type="password" id="confirm-password" required></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Personal & Parent Information</h2>
                </div>
                <div class="accordion-content">
                    <h3>Personal Details</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="umis_id">UMIS ID</label><input type="text" id="umis_id"
                                name="umis_id"></div>
                        <div class="input-group"><label for="emis_id">EMIS ID</label><input type="text" id="emis_id"
                                name="emis_id"></div>
                        <div class="input-group"><label for="abc_id">ABC ID</label><input type="text" id="abc_id"
                                name="abc_id"></div>
                        <div class="input-group"><label for="date_of_birth">Date of Birth</label><input type="date"
                                id="date_of_birth" name="date_of_birth"></div>
                        <div class="input-group"><label for="gender">Gender</label><select id="gender" name="gender">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select></div>
                        <div class="input-group"><label for="blood_group">Blood Group</label><select id="blood_group"
                                name="blood_group">
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select></div>
                        <div class="input-group"><label for="community">Community</label><select id="community"
                                name="community">
                                <option value="OC">OC</option>
                                <option value="BC">BC</option>
                                <option value="MBC">MBC</option>
                                <option value="SC">SC</option>
                                <option value="ST">ST</option>
                            </select></div>
                        <div class="input-group"><label for="caste">Caste</label><select id="caste"
                                name="caste"></select></div>
                        <div class="input-group" id="caste-other-group" style="display: none;"><label
                                for="caste_other">Please Specify Caste</label><input type="text" id="caste_other"
                                name="caste_other"></div>
                        <div class="input-group"><label for="religion">Religion</label><select id="religion"
                                name="religion">
                                <option value="Hindu">Hindu</option>
                                <option value="Christian">Christian</option>
                                <option value="Muslim">Muslim</option>
                                <option value="Other">Other</option>
                            </select></div>
                        <div class="input-group"><label for="aadhaar_number">Aadhaar Number</label><input type="text"
                                id="aadhaar_number" name="aadhaar_number"></div>
                        <div class="input-group"><label for="permanent_address">Permanent Address</label><textarea
                                id="permanent_address" name="permanent_address"></textarea></div>
                        <div class="input-group"><label for="present_address">Present Address</label><textarea
                                id="present_address" name="present_address"></textarea></div>
                        <div class="input-group radio-group">
                            <label>Are you applying for a scholarship?</label>
                            <div>
                                <input type="radio" id="scholarship-yes" name="has_scholarship" value="yes"> <label
                                    for="scholarship-yes">Yes</label>
                                <input type="radio" id="scholarship-no" name="has_scholarship" value="no" checked>
                                <label for="scholarship-no">No</label>
                            </div>
                        </div>
                    </div>
                    <h3>Parent & Contact Details</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="student_mobile">Student Mobile</label><input type="tel"
                                id="student_mobile" name="student_mobile"></div>
                        <div class="input-group"><label for="father_name">Father's Name</label><input type="text"
                                id="father_name" name="father_name"></div>
                        <div class="input-group"><label for="father_occupation">Father's Occupation</label><input
                                type="text" id="father_occupation" name="father_occupation"></div>
                        <div class="input-group"><label for="father_mobile">Father's Mobile</label><input type="tel"
                                id="father_mobile" name="father_mobile"></div>
                        <div class="input-group"><label for="mother_name">Mother's Name</label><input type="text"
                                id="mother_name" name="mother_name"></div>
                        <div class="input-group"><label for="mother_occupation">Mother's Occupation</label><input
                                type="text" id="mother_occupation" name="mother_occupation"></div>
                        <div class="input-group"><label for="mother_mobile">Mother's Mobile</label><input type="tel"
                                id="mother_mobile" name="mother_mobile"></div>
                        <div class="input-group"><label for="parent_annual_income">Parent's Annual Income</label><input
                                type="number" id="parent_annual_income" name="parent_annual_income"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Academic Details</h2>
                </div>
                <div class="accordion-content">
                    <div class="input-group">
                        <label for="program_level">Current Program Level</label>
                        <select id="program_level" name="program_level">
                            <option value="">-- Select Program --</option>
                            <option value="UG">Undergraduate</option>
                            <option value="PG">Postgraduate</option>
                            <option value="PHD">PhD</option>
                        </select>
                    </div>
                    <div id="current-program-details-section" class="conditional-section">
                        <h3>Current Program Details</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="current_semester">Current Semester</label>
                                <select id="current_semester" name="current_semester" required>
                                    <option value="">-- Select Semester --</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                    <option value="7">Semester 7</option>
                                    <option value="8">Semester 8</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="joining_year">Joining Year</label>
                                <select id="joining_year" name="joining_year" class="year-picker"></select>
                            </div>
                            <div class="input-group">
                                <label for="ending_year">Ending Year (Batch)</label>
                                <select id="ending_year" name="ending_year" class="year-picker"></select>
                            </div>
                        </div>
                    </div>

                    <div id="ug-entry-type-section" class="conditional-section">
                        <div class="input-group">
                            <label for="ug_entry_type">UG Entry Type</label>
                            <select id="ug_entry_type" name="ug_entry_type">
                                <option value="">-- Select Entry Type --</option>
                                <option value="Regular">Regular (HSC)</option>
                                <option value="Lateral">Lateral (Diploma)</option>
                                <option value="Rejoin">Rejoin</option>
                            </select>
                        </div>
                    </div>
                    <div id="sslc-details-section" class="conditional-section">
                        <h3>SSLC Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>SSLC School Name</label><input type="text"
                                    name="sslc_school_name"></div>
                            <div class="input-group"><label>SSLC School Address</label><textarea
                                    name="sslc_school_address"></textarea></div>
                            <div class="input-group"><label>SSLC Register Number</label><input type="text"
                                    name="sslc_register_number"></div>
                            <div class="input-group"><label>SSLC Overall Percentage</label><input type="number"
                                    step="0.01" min="0" max="100" name="sslc_percentage"></div>
                            <div class="input-group"><label>SSLC Year of Passing</label><select
                                    name="sslc_year_of_passing" class="year-picker"></select></div>
                        </div>
                    </div>
                    <div id="hsc-details-section" class="conditional-section">
                        <h3>HSC Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>HSC School Name</label><input type="text"
                                    name="hsc_school_name"></div>
                            <div class="input-group"><label>HSC School Address</label><textarea
                                    name="hsc_school_address"></textarea></div>
                            <div class="input-group"><label>HSC Register Number</label><input type="text"
                                    name="hsc_register_number"></div>
                            <div class="input-group"><label>HSC Overall Percentage</label><input type="number"
                                    step="0.01" min="0" max="100" name="hsc_percentage"></div>
                            <div class="input-group"><label>HSC Year of Passing</label><select
                                    name="hsc_year_of_passing" class="year-picker"></select></div>
                        </div>
                    </div>
                    <div id="diploma-details-section" class="conditional-section">
                        <h3>Diploma Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>Diploma College Name</label><input type="text"
                                    name="diploma_college_name"></div>
                            <div class="input-group"><label>Diploma College Address</label><textarea
                                    name="diploma_college_address"></textarea></div>
                            <div class="input-group"><label>Diploma Register Number</label><input type="text"
                                    name="diploma_register_number"></div>
                            <div class="input-group"><label>Diploma Overall Percentage</label><input type="number"
                                    step="0.01" min="0" max="100" name="diploma_percentage"></div>
                            <div class="input-group"><label>Diploma Year of Passing</label><select
                                    name="diploma_year_of_passing" class="year-picker"></select></div>
                        </div>
                    </div>
                    <div id="ug-details-section" class="conditional-section">
                        <h3>UG Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>UG Course</label><input type="text" name="ug_course"></div>
                            <div class="input-group"><label>UG University</label><input type="text"
                                    name="ug_university"></div>
                            <div class="input-group"><label>UG OGPA (out of 100)</label><input type="number" step="0.01"
                                    min="0" max="100" name="ug_ogpa"></div>
                            <div class="input-group"><label>UG Year of Passing</label><select name="ug_year_of_passing"
                                    class="year-picker"></select></div>
                        </div>
                    </div>
                    <div id="pg-details-section" class="conditional-section">
                        <h3>PG Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>PG Course</label><input type="text" name="pg_course"></div>
                            <div class="input-group"><label>PG University</label><input type="text"
                                    name="pg_university"></div>
                            <div class="input-group"><label>PG OGPA (out of 100)</label><input type="number" step="0.01"
                                    min="0" max="100" name="pg_ogpa"></div>
                            <div class="input-group"><label>PG Year of Passing</label><select name="pg_year_of_passing"
                                    class="year-picker"></select></div>
                        </div>
                    </div>
                    <div id="phd-details-section" class="conditional-section">
                        <h3>PhD Details</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>PhD Specialization</label><input type="text"
                                    name="phd_specialization"></div>
                            <div class="input-group"><label>PhD University</label><input type="text"
                                    name="phd_university"></div>
                            <div class="input-group"><label>PhD Year of Joining</label><select
                                    name="phd_year_of_joining" class="year-picker"></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Bank Details</h2>
                </div>
                <div class="accordion-content">
                    <div class="form-grid">
                        <div class="input-group"><label for="account_holder_name">Account Holder's Name</label><input
                                type="text" id="account_holder_name" name="account_holder_name"></div>
                        <div class="input-group"><label for="account_number">Account Number</label><input type="text"
                                id="account_number" name="account_number"></div>
                        <div class="input-group"><label for="bank_name">Bank Name</label><input type="text"
                                id="bank_name" name="bank_name"></div>
                        <div class="input-group"><label for="branch_name">Branch Name</label><input type="text"
                                id="branch_name" name="branch_name"></div>
                        <div class="input-group"><label for="ifsc_code">IFSC Code</label><input type="text"
                                id="ifsc_code" name="ifsc_code"></div>
                    </div>
                </div>
            </div>

            <div id="scholarship-accordion-item" class="accordion-item">
                <div class="accordion-header">
                    <h2>Scholarship Details</h2>
                </div>
                <div class="accordion-content">
                    <div class="form-grid">
                        <div class="input-group">
                            <div class="checkbox-group"><label>First Graduate</label><input type="checkbox"
                                    id="is_first_graduate_sch" name="is_first_graduate"></div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>BC/MBC</label><input type="checkbox" name="sch_bcmbc">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Post Metric</label><input type="checkbox"
                                    name="sch_postmetric"></div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Prime Minister Scheme</label><input type="checkbox"
                                    name="sch_pm"></div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Govt 7.5%</label><input type="checkbox" name="sch_govt">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Pudhumai Penn</label><input type="checkbox"
                                    name="sch_pudhumai"></div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Tamizh Pudhalvan</label><input type="checkbox"
                                    name="sch_tamizh"></div>
                        </div>
                        <div class="input-group">
                            <div class="checkbox-group"><label>Private Scholarship</label><input type="checkbox"
                                    id="sch_private" name="sch_private"></div>
                        </div>
                    </div>
                    <div id="private-scholarship-name-section" class="conditional-section">
                        <div class="input-group"><label for="private_scholarship_name">Private Scholarship
                                Name</label><input type="text" id="private_scholarship_name"
                                name="private_scholarship_name"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Document Uploads</h2>
                </div>
                <div class="accordion-content">
                    <div class="form-grid">
                        <div class="input-group"><label for="student_photo">Student Photo</label><input type="file"
                                id="student_photo" name="student_photo"></div>
                        <div class="input-group"><label for="student_id_card">Student ID Card</label><input type="file"
                                id="student_id_card" name="student_id_card"></div>
                        <div class="input-group"><label for="community_certificate">Community Certificate</label><input
                                type="file" id="community_certificate" name="community_certificate"></div>
                        <div class="input-group"><label for="aadhaar_card">Aadhaar Card</label><input type="file"
                                id="aadhaar_card" name="aadhaar_card"></div>
                        <div class="input-group"><label for="sslc_marksheet">SSLC Marksheet</label><input type="file"
                                id="sslc_marksheet" name="sslc_marksheet"></div>
                        <div class="input-group"><label for="hsc_marksheet">HSC Marksheet</label><input type="file"
                                id="hsc_marksheet" name="hsc_marksheet"></div>
                        <div class="input-group"><label for="income_certificate">Income Certificate</label><input
                                type="file" id="income_certificate" name="income_certificate"></div>
                        <div class="input-group"><label for="bank_passbook">Bank Passbook</label><input type="file"
                                id="bank_passbook" name="bank_passbook"></div>
                        <div class="input-group"><label for="driving_license">Driving License</label><input type="file"
                                id="driving_license" name="driving_license"></div>
                        <div id="fg-cert-upload-section" class="input-group conditional-section"><label
                                for="first_graduate_certificate">First Graduate Certificate</label><input type="file"
                                id="first_graduate_certificate" name="first_graduate_certificate"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">
                    <h2>Other Details</h2>
                </div>
                <div class="accordion-content">
                    <div class="form-grid">
                        <div class="input-group"><label for="ambition">Ambition</label><input type="text" id="ambition"
                                name="ambition"></div>
                        <div class="input-group"><label for="role_model">Role Model</label><input type="text"
                                id="role_model" name="role_model"></div>
                        <div class="input-group"><label for="hobbies">Hobbies</label><textarea id="hobbies"
                                name="hobbies"></textarea></div>
                        <div class="input-group"><label for="identification_marks">Identification Marks</label><textarea
                                id="identification_marks" name="identification_marks"></textarea></div>
                        {% comment %} <div class="input-group"><label for="security_question_1">1 QUESTION</label><input
                                type="text" id="security_question_1" name="security_question_1"></div>
                        <div class="input-group"><label for="security_answer_1">1 ANSWER</label><input type="text"
                                id="security_answer_1" name="security_answer_1"></div>
                        <div class="input-group"><label for="security_question_2">2 QUESTION</label><input type="text"
                                id="security_question_2" name="security_question_2"></div>
                        <div class="input-group"><label for="security_answer_2">2 ANSWER</label><input type="text"
                                id="security_answer_2" name="security_answer_2"></div> {% endcomment %}
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn">Submit Registration</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ... (Variable and Helper definitions are same) ...
            let subCasteData = {};
            function updateActiveAccordionHeight() {
                const activeItem = document.querySelector('.accordion-item.active');
                if (activeItem) {
                    const content = activeItem.querySelector('.accordion-content');
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }, 50);
                }
            }

            // ... (Accordion Year Picker Code as is) ...
            const accordionItems = document.querySelectorAll('.accordion-item');
            if (accordionItems.length > 0) {
                accordionItems[0].classList.add('active');
                const firstContent = accordionItems[0].querySelector('.accordion-content');
                if (firstContent) {
                    firstContent.style.maxHeight = firstContent.scrollHeight + "px";
                }
            }
            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header');
                header.addEventListener('click', () => {
                    const content = item.querySelector('.accordion-content');
                    const isActive = item.classList.contains('active');
                    document.querySelectorAll('.accordion-item.active').forEach(openItem => {
                        openItem.classList.remove('active');
                        openItem.querySelector('.accordion-content').style.maxHeight = '0px';
                        openItem.classList.remove('active');
                    });
                    if (!isActive) {
                        item.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });

            document.querySelectorAll('.year-picker').forEach(dropdown => {
                const currentYear = new Date().getFullYear();
                let startLoopYear = currentYear;
                if (dropdown.id === 'ending_year') startLoopYear = currentYear + 6;
                const minYear = currentYear - 40;
                const placeholder = document.createElement('option');
                placeholder.value = ""; placeholder.textContent = "-- Select Year --";
                dropdown.appendChild(placeholder);
                for (let year = startLoopYear; year >= minYear; year--) {
                    const option = document.createElement('option');
                    option.value = year; option.textContent = year;
                    dropdown.appendChild(option);
                }
            });

            // Caste Logic
            const communitySelect = document.getElementById('community');
            const casteSelect = document.getElementById('caste');
            const casteOtherGroup = document.getElementById('caste-other-group');

            function updateCasteOptions() {
                const selectedCommunity = communitySelect.value;
                const castes = subCasteData[selectedCommunity] || [];
                casteSelect.innerHTML = ''; casteOtherGroup.style.display = 'none';

                if (castes.length === 0) {
                    const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'Select Community First'; casteSelect.appendChild(opt);
                } else {
                    const opt = document.createElement('option'); opt.value = ''; opt.textContent = '-- Select --'; casteSelect.appendChild(opt);
                    castes.forEach(c => {
                        const o = document.createElement('option'); o.value = c; o.textContent = c; casteSelect.appendChild(o);
                    });
                    const other = document.createElement('option'); other.value = 'Other'; other.textContent = 'Other'; casteSelect.appendChild(other);
                }
            }
            if (communitySelect) communitySelect.addEventListener('change', updateCasteOptions);

            if (casteSelect) {
                casteSelect.addEventListener('change', function () {
                    casteOtherGroup.style.display = this.value === 'Other' ? 'block' : 'none';
                    updateActiveAccordionHeight();
                });
            }

            // Conditional Logic
            const programLevelSelect = document.getElementById('program_level');
            const ugEntryTypeSection = document.getElementById('ug-entry-type-section');
            const ugEntryTypeSelect = document.getElementById('ug_entry_type');

            function handleProgramChange() {
                // ... existing logic ...
                const level = programLevelSelect.value;
                const section = document.getElementById('current-program-details-section');
                if (section) section.style.display = level ? 'block' : 'none';
                ugEntryTypeSection.style.display = level === 'UG' ? 'block' : 'none';

                // Show/Hide sections
                document.getElementById('sslc-details-section').style.display = 'none';
                document.getElementById('ug-details-section').style.display = (level === 'PG' || level === 'PHD') ? 'block' : 'none';
                document.getElementById('pg-details-section').style.display = (level === 'PHD') ? 'block' : 'none';
                document.getElementById('phd-details-section').style.display = (level === 'PHD') ? 'block' : 'none';
                handleEntryTypeChange(); // Call this to set SSL/HSC
                updateActiveAccordionHeight();
            }

            function handleEntryTypeChange() {
                const entry = ugEntryTypeSelect.value;
                document.getElementById('sslc-details-section').style.display = (entry === 'Regular' || entry === 'Lateral') ? 'block' : 'none';
                document.getElementById('hsc-details-section').style.display = (entry === 'Regular') ? 'block' : 'none';
                document.getElementById('diploma-details-section').style.display = (entry === 'Lateral') ? 'block' : 'none';
                updateActiveAccordionHeight();
            }

            if (programLevelSelect) programLevelSelect.addEventListener('change', handleProgramChange);
            if (ugEntryTypeSelect) ugEntryTypeSelect.addEventListener('change', handleEntryTypeChange);

            // VALIDATION
            const form = document.getElementById('registration-form');
            if (form) {
                form.addEventListener('submit', async function (event) {
                    event.preventDefault();
                    let errors = [];

                    // 1. Generic Required Field Validation
                    // Check all elements with 'required' attribute
                    const requiredElements = form.querySelectorAll('[required]');
                    requiredElements.forEach(el => {
                        // Check if element is effectively visible (not in a hidden conditional section)
                        // Note: Collapsed accordion content is technically "visible" to the DOM (just height 0), 
                        // so offsetParent is usually NOT null. This is good: we WANT to validate closed accordions.
                        // Fields in 'display: none' sections (conditional logic) will have offsetParent === null and be skipped.
                        if (el.offsetParent !== null && !el.value.trim()) {
                            // Get a human readable name
                            let label = "Field";
                            const id = el.id;
                            if (id) {
                                const labelEl = document.querySelector(`label[for="${id}"]`);
                                if (labelEl) label = labelEl.textContent;
                            } else {
                                label = el.name || "Field";
                            }
                            errors.push(`${label} is required.`);
                        }
                    });

                    // 2. Helper for Regex
                    const validateRegex = (id, regex, msg) => {
                        const el = document.getElementById(id);
                        // Validation applies only if value is present (required check handles empty)
                        if (el && el.value && !regex.test(el.value)) errors.push(msg);
                    };

                    // 3. Specific Passwords Check
                    const pw = document.getElementById('password');
                    const cpw = document.getElementById('confirm-password');
                    if (pw && pw.value.length < 6) errors.push("Password must be at least 6 characters.");
                    if (pw && cpw && pw.value !== cpw.value) errors.push("Passwords do not match.");

                    // 4. Specific Patterns
                    validateRegex('student_mobile', /^\d{10}$/, "Student Mobile must be 10 digits.");
                    validateRegex('father_mobile', /^\d{10}$/, "Father Mobile must be 10 digits.");
                    validateRegex('mother_mobile', /^\d{10}$/, "Mother Mobile must be 10 digits.");
                    validateRegex('aadhaar_number', /^\d{12}$/, "Aadhaar Number must be 12 digits.");
                    validateRegex('ifsc_code', /^[A-Z]{4}0[A-Z0-9]{6}$/, "Invalid IFSC Code.");
                    validateRegex('student_email', /^[^\s@]+@[^\s@]+\.[^\s@]+$/, "Invalid Email Format.");

                    // 5. Numeric Ranges (Percentages)
                    const checkRange = (name, min, max, label) => {
                        const el = document.querySelector(`input[name="${name}"]`);
                        // offsetParent check to ensure we don't validate hidden conditional fields
                        if (el && el.offsetParent !== null && el.value) {
                            const val = parseFloat(el.value);
                            if (val < min || val > max) errors.push(`${label} must be between ${min} and ${max}.`);
                        }
                    };
                    checkRange('sslc_percentage', 0, 100, "SSLC Percentage");
                    checkRange('hsc_percentage', 0, 100, "HSC Percentage");
                    checkRange('diploma_percentage', 0, 100, "Diploma Percentage");
                    checkRange('ug_ogpa', 0, 100, "UG OGPA");
                    checkRange('pg_ogpa', 0, 100, "PG OGPA");

                    // 6. Age Check
                    const dobEl = document.getElementById('date_of_birth');
                    if (dobEl && dobEl.value) {
                        const dob = new Date(dobEl.value);
                        const age = (new Date() - dob) / (365.25 * 24 * 60 * 60 * 1000);
                        if (age < 15) errors.push("Student must be at least 15 years old.");
                    }

                    if (errors.length > 0) {
                        // Unique errors only
                        const uniqueErrors = [...new Set(errors)];
                        alert("Please fix the following errors:\n\n" + uniqueErrors.join("\n"));
                        return;
                    }

                    // Submission
                    const formData = new FormData(form);
                    try {
                        const response = await fetch("{% url 'api_register_student' %}", {
                            method: 'POST',
                            body: formData,
                            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                        });
                        const result = await response.json();
                        if (response.ok) {
                            window.location.href = "{% url 'registration_success' %}";
                        } else {
                            if (result.error) alert('Server Error: ' + result.error);
                            else alert('Registration failed. Please check your data.');
                        }
                    } catch (error) {
                        console.error('Submission Error:', error);
                        alert('Network Error.');
                    }
                });
            }

            // Fetch Data
            async function fetchCasteData() {
                try {
                    const response = await fetch("{% url 'api_get_castes' %}");
                    if (response.ok) {
                        subCasteData = await response.json();
                        updateCasteOptions();
                    }
                } catch (e) { console.error(e); }
            }

            // Initial calls
            fetchCasteData();
            const schRadios = document.querySelectorAll('input[name="has_scholarship"]');
            schRadios.forEach(r => r.addEventListener('change', () => {
                const val = document.querySelector('input[name="has_scholarship"]:checked').value;
                document.getElementById('scholarship-accordion-item').style.display = (val === 'yes') ? 'block' : 'none';
            }));
        });
    </script>
</body>

</html>
```