<button id="staff-webpush-button" class="icon-style" title="Enable Notifications"
    style="margin-right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">ðŸ””</button>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const vapidPublicKey = 'BGM2HPOvDQ/xLSfPKovQ/nT1BVaA1g1WSCuxynHK7EklnqJsPd3mvUdaXLqLrV3VYqXNOOcHl8n/8SuwE09GDiI=';
        const staffId = "{{ staff.staff_id }}"; // Django template variable
        const groupName = "staff_" + staffId;

        const btn = document.getElementById('staff-webpush-button');

        // Toast Helper
        function showToast(message, type = 'success') {
            // Create toast container if not exists
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.style.minWidth = '250px';
            toast.style.marginBottom = '10px';
            toast.style.padding = '15px';
            toast.style.borderRadius = '4px';
            toast.style.color = 'white';
            toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease';

            if (type === 'success') {
                toast.style.backgroundColor = '#28a745'; // Green
            } else if (type === 'error') {
                toast.style.backgroundColor = '#dc3545'; // Red
            } else {
                toast.style.backgroundColor = '#17a2b8'; // Blue
            }

            toast.textContent = message;
            container.appendChild(toast);

            // Show
            setTimeout(() => toast.style.opacity = '1', 10);

            // Hide
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Cookie Helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        if ('serviceWorker' in navigator && 'PushManager' in window) {

            // Check existing subscription
            navigator.serviceWorker.getRegistration().then(function (reg) {
                if (reg) {
                    reg.pushManager.getSubscription().then(function (sub) {
                        if (sub) {
                            // Already subscribed
                            btn.textContent = 'ðŸ”•';
                            btn.setAttribute('data-status', 'subscribed');
                            btn.title = "Disable Notifications";
                        } else {
                            btn.setAttribute('data-status', 'unsubscribed');
                        }
                    });
                }
            });


            btn.addEventListener('click', function () {
                const status = btn.getAttribute('data-status');

                if (status === 'subscribed') {
                    // Unsubscribe logic (Optional: Just clearing local is easy, hitting server is better)
                    // For simplicity, we just unsubscribe locally and update UI
                    navigator.serviceWorker.getRegistration().then(function (reg) {
                        reg.pushManager.getSubscription().then(function (sub) {
                            if (sub) {
                                sub.unsubscribe().then(function () {
                                    btn.textContent = 'ðŸ””';
                                    btn.setAttribute('data-status', 'unsubscribed');
                                    btn.title = "Enable Notifications";
                                    showToast('Notifications Disabled', 'info');
                                });
                            }
                        });
                    });
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '...';

                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(function (registration) {
                        return registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                        });
                    })
                    .then(function (subscription) {
                        // Detect Browser
                        let browserName = "Unknown";
                        const userAgent = navigator.userAgent;
                        if (userAgent.indexOf("Firefox") > -1) browserName = "Firefox";
                        else if (userAgent.indexOf("Chrome") > -1) browserName = "Chrome";
                        else if (userAgent.indexOf("Safari") > -1) browserName = "Safari";
                        // ... others

                        const payload = {
                            status_type: 'subscribe',
                            group: groupName,
                            subscription: subscription.toJSON(),
                            browser: browserName,
                            user_agent: userAgent
                        };

                        return fetch('/webpush/save_information', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify(payload)
                        });
                    })
                    .then(async response => {
                        if (response.ok) {
                            btn.disabled = false;
                            btn.textContent = 'ðŸ”•';
                            btn.setAttribute('data-status', 'subscribed');
                            btn.title = "Disable Notifications";
                            showToast('Notifications Enabled Successfully!', 'success');
                        } else {
                            throw new Error('Server failed to save');
                        }
                    })
                    .catch(err => {
                        console.error('Subscription error:', err);
                        showToast('Failed to enable notifications.', 'error');
                        btn.disabled = false;
                        btn.textContent = 'ðŸ””';
                    });
            });
        } else {
            console.warn('Push messaging is not supported');
            btn.style.display = 'none';
        }
    });
</script>